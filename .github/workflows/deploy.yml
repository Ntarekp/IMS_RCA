name: Deploy RCA IMS Backend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: [self-hosted, backend]

    steps:
      - uses: actions/checkout@v4

     
      - name: Load env variables from config
        run: |
          export $(grep -v '^#' /opt/configs/rca-backend/.env | xargs)
          echo "DB_URL=$DB_URL"
          echo "DB_USER=$DB_USER"
          echo "DB_PASS=$DB_PASS"
          echo "SMTP_USER=$SMTP_USER"
          echo "SMTP_PASS=$SMTP_PASS"

      
      - name: Make mvnw executable
        run: chmod +x mvnw

      
      - name: Build backend
        run: ./mvnw clean package -DskipTests

    
      - name: Deploy JAR
        run: |
          mkdir -p /opt/apps/rca-backend
          cp target/*.jar /opt/apps/rca-backend/rca-backend.jar

      
      - name: Restart backend with PM2
        run: |
          # Install PM2 if not installed
          npm install -g pm2 || true

          # Load environment variables for PM2
          export $(grep -v '^#' /opt/configs/rca-backend/.env | xargs)

          # Start or restart the backend with PM2
          pm2 start /opt/apps/rca-backend/rca-backend.jar \
            --name rca-backend \
            --interpreter java \
            --interpreter-args "-jar" \
            --update-env \
            || pm2 restart rca-backend --update-env

          # Save PM2 process list so it survives server reboot
          pm2 save
